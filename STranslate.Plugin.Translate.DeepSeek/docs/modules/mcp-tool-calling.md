# MCP 工具调用详解

## 概述

DeepSeekMCP 插件的核心特色是支持 **MCP（Model Context Protocol）服务器工具调用**。这使得 AI 在翻译过程中能够动态调用外部工具，获取实时信息、执行特定操作，从而提供上下文感知、更准确、更智能的翻译结果。

## 什么是 MCP？

**MCP（Model Context Protocol，模型上下文协议）** 是一种标准化的协议，允许 AI 模型通过统一的接口调用外部工具和服务。它采用 JSON-RPC 2.0 格式进行通信，支持以下核心功能：

- **工具发现**：动态获取服务器提供的可用工具列表
- **工具调用**：根据翻译需求调用特定工具
- **上下文传递**：将工具执行结果反馈给 AI，用于后续翻译决策

## MCP 服务器类型

你可以连接各种类型的 MCP 服务器：

### 1. 搜索类服务器
- **网络搜索**：Google、Bing、百度等搜索引擎
- **知识库搜索**：Wiki、企业知识库、文档库
- **代码搜索**：GitHub、GitLab 代码库搜索

**使用场景**：
- 翻译专业术语时搜索最新定义
- 翻译技术文档时查询 API 文档
- 翻译新闻时获取实时背景信息

### 2. 数据处理类服务器
- **数据库查询**：SQL 查询、NoSQL 查询
- **文件操作**：读取本地文件、解析文档格式
- **数据转换**：格式转换、数据清洗

**使用场景**：
- 翻译数据库相关内容时查询表结构
- 读取本地术语库进行统一翻译
- 处理需要数据上下文的翻译任务

### 3. 计算执行类服务器
- **代码执行**：Python、JavaScript 代码执行
- **数学计算**：复杂公式计算
- **逻辑处理**：规则引擎、条件判断

**使用场景**：
- 翻译编程相关内容时验证代码示例
- 处理包含数学公式的技术文档
- 执行自定义的翻译逻辑或格式转换

### 4. 外部服务类服务器
- **API 集成**：调用第三方 API 服务
- **认证服务**：OAuth、Token 管理
- **通知服务**：发送通知、记录日志

**使用场景**：
- 翻译电商内容时查询商品信息
- 翻译社交媒体内容时获取用户上下文
- 集成企业内部的业务系统

## 工具调用策略

DeepSeekMCP 提供 **5 种工具调用策略**，灵活控制 AI 使用工具的时机和方式：

| 策略 | 连接时机 | 工具使用 | 适用场景 |
|------|----------|----------|----------|
| **Disabled** | 不连接 | 不使用 | 仅需基础翻译，不需要工具支持 |
| **Blank** | 立即连接 | AI 自行判断 | 通用场景，让 AI 决定是否需要工具 |
| **Hybrid** | 立即连接 | 可选使用 | 大部分翻译不需要工具，但保留工具能力 |
| **ToolFirst** | 立即连接 | 优先使用 | 专业翻译、术语密集型任务 |
| **ToolForced** | 立即连接 | 必须使用 | 所有翻译都必须通过工具增强 |

## 工具调用流程

### 完整翻译流程

```
用户输入待翻译文本
    ↓
DeepSeekMCP 接收请求
    ↓
根据策略决定是否启用 MCP
    ↓
    ├─ 禁用 → 直接调用 DeepSeek API（传统翻译）
    └─ 启用 → 初始化 MCP 连接
                ↓
            获取可用工具列表
                ↓
            构建系统提示词（包含工具说明）
                ↓
            发送请求到 DeepSeek（非流式）
                ↓
            AI 分析并决定是否调用工具
                ↓
            ├─ 直接回答 → 返回翻译结果
            └─ 需要工具 → 执行工具调用
                                ↓
                            获取工具执行结果
                                ↓
                            将结果加入上下文
                                ↓
                            再次发送请求（循环直到完成）
                                ↓
                            返回最终翻译结果
```

### 多轮工具调用示例

假设用户要求翻译一段关于最新 AI 技术的技术文档：

```
AI: 我需要翻译这段关于 GPT-5 的技术描述，但我对 GPT-5 的具体参数不了解。

[AI 决定调用工具]
    ↓
调用工具：web_search(query="GPT-5 specifications parameters")
    ↓
工具返回：GPT-5 的详细技术规格和参数信息
    ↓
AI: 现在我有了 GPT-5 的背景信息，可以准确翻译这段技术文档了。

[AI 再次决定调用工具]
    ↓
调用工具：query_database(sql="SELECT cn_term FROM tech_terms WHERE en_term LIKE '%transformer%'")
    ↓
工具返回：Transformer 相关术语的中文标准译名
    ↓
AI: 有了术语库的支持，翻译会更加规范。

[AI 完成翻译]
    ↓
返回最终翻译结果（包含准确的技术术语和背景解释）
```

## 工具链显示

在翻译结果中，你可以选择显示工具调用链，了解 AI 在翻译过程中使用了哪些工具：

```
「web_search✅」「query_database✅」「calculate✅」
```

- **✅** 表示工具调用成功
- **❌** 表示工具调用失败或返回空

**注意**：工具链显示现在是按策略设置的，不同策略可以独立配置是否显示工具链。使用 `/工具链` 命令或策略编辑对话框进行设置。

这对于调试和理解 AI 的翻译决策非常有用。

## 配置 MCP 服务器

### 1. 服务器配置参数

```json
{
  "name": "Web Search Server",
  "url": "http://localhost:3000/mcp",
  "auth": "Bearer token123",
  "enabled": true
}
```

**参数说明**：
- **name**: 服务器显示名称
- **url**: MCP 服务器地址（支持 HTTP/HTTPS）
- **auth**: 认证信息（如 Bearer Token、API Key）
- **enabled**: 是否启用该服务器

### 2. 工具管理

每个服务器可以配置多个工具，你可以：
- **启用/禁用** 特定工具
- 查看工具的 **描述** 和 **参数说明**
- 测试工具 **连接状态**

### 3. 多服务器支持

可以同时配置多个 MCP 服务器：
- 搜索服务器（Google、Bing）
- 数据库服务器（MySQL、PostgreSQL）
- 代码执行服务器（Python、Node.js）
- 企业服务服务器（内部 API）

AI 会根据翻译需求自动选择合适的工具。

## 实际应用示例

### 场景 1：技术文档翻译

**原文**：
> The new GPT-5 model uses a mixture-of-experts architecture with 1.8 trillion parameters.

**启用 MCP 后**：
```
AI: 我需要确认 GPT-5 的中文标准译名和参数详情。
调用工具：search_wiki("GPT-5 模型参数")
工具返回：GPT-5 技术规格确认，中文译为"生成式预训练 Transformer 5"

AI: 现在我可以准确翻译了。
翻译结果：新推出的 GPT-5（生成式预训练 Transformer 5）模型采用混合专家架构，拥有 1.8 万亿参数。
```

### 场景 2：多语言术语统一

**原文**：
> The API endpoint returns a JSON object containing user metadata.

**启用 MCP 后**：
```
AI: 需要查询我们公司术语库中 API endpoint、JSON object 的标准译法。
调用工具：query_terminology(["API endpoint", "JSON object", "metadata"])
工具返回：API 端点、JSON 对象、元数据

翻译结果：API 端点返回一个包含用户元数据的 JSON 对象。
```

### 场景 3：实时信息翻译

**原文**：
> The stock price of NVIDIA reached $500 yesterday.

**启用 MCP 后**：
```
AI: 股价数据可能已经过时，需要验证当前价格。
调用工具：get_stock_price("NVIDIA")
工具返回：当前股价 $487.50（注意：原文数据需要更新）

AI: 我应该提供准确的当前数据。
翻译结果：英伟达（NVIDIA）昨日股价达到 487.50 美元（注：原文提到 500 美元为历史数据）。
```

## 性能优化建议

### 1. 工具选择策略

- **只在必要时启用 MCP**：简单翻译不需要工具支持
- **使用合适的策略**：
  - 普通文本 → Disabled/Blank
  - 专业文档 → ToolFirst
  - 实时数据 → Hybrid

### 2. 服务器性能优化

- **本地服务器优先**：减少网络延迟
- **连接池复用**：避免频繁创建连接
- **工具缓存**：缓存常用工具列表

### 3. 超时设置

- **连接超时**：10-30 秒（根据网络环境）
- **工具调用超时**：5-15 秒
- **总翻译超时**：60-120 秒

## 故障排除

### 常见问题

1. **工具调用超时**
   - 检查网络连接
   - 增加超时时间设置
   - 确认 MCP 服务器正常运行

2. **工具返回空结果**
   - 检查工具参数是否正确
   - 验证认证信息（Token、API Key）
   - 查看 MCP 服务器日志

3. **翻译速度变慢**
   - 减少启用的工具数量
   - 考虑使用 Disabled 策略禁用MCP
   - 优化 MCP 服务器性能

4. **AI 不调用工具**
   - 确认策略不是 Disabled
   - 检查工具是否正确启用
   - 查看系统提示词是否包含工具说明

## 扩展开发

### 创建自定义 MCP 服务器

你可以开发自己的 MCP 服务器来支持特定业务需求：

```python
# 示例：术语库 MCP 服务器
from mcp.server import Server

app = Server("terminology-server")

@app.tool()
def query_term(term: str) -> str:
    """查询术语的标准译名"""
    # 查询数据库或 API
    return get_translation_from_db(term)

@app.tool()
def add_term(term: str, translation: str):
    """添加新术语"""
    save_to_terminology_db(term, translation)
```

### 集成现有服务

将企业内部的 API、数据库、知识库封装为 MCP 服务器：
- **CRM 系统**：客户信息查询
- **ERP 系统**：产品规格查询
- **内部 Wiki**：企业知识库搜索
- **日志系统**：错误代码查询

## 相关文档

- [MCP 协议规范](https://modelcontextprotocol.io/)
- [MCP 客户端实现](./mcp-client.md)
- [工具调用策略](./tool-strategy.md)
- [故障排除指南](../guides/troubleshooting.md)

---

**提示**：MCP 工具调用是 DeepSeekMCP 插件的核心优势，合理配置可以显著提升翻译质量和效率。建议根据实际业务需求选择合适的 MCP 服务器和工具策略。

*最后更新：2025年2月*
