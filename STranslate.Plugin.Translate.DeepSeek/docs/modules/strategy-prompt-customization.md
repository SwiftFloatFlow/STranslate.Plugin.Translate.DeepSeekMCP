# ç­–ç•¥æç¤ºè¯è‡ªå®šä¹‰åŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

æ”¯æŒå¯¹æ¯ä¸ªMCPç­–ç•¥ï¼ˆç©ºç™½ç­–ç•¥ã€æ··åˆåˆ¤æ–­ã€å·¥å…·ä¼˜å…ˆã€å·¥å…·å¼ºåˆ¶ï¼‰è¿›è¡Œè¯¦ç»†é…ç½®ï¼š

1. **è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯** - ç¼–è¾‘ç­–ç•¥çš„æç¤ºè¯ï¼Œç²¾ç¡®æ§åˆ¶AIè¡Œä¸º
2. **å·¥å…·è°ƒç”¨ä¸Šé™** - è®¾ç½®æ€»å·¥å…·è°ƒç”¨æ¬¡æ•°ä¸Šé™å’ŒåŒä¸€å·¥å…·è¿ç»­è°ƒç”¨ä¸Šé™
3. **å·¥å…·ç»“æœæ˜¾ç¤ºæ¨¡å¼** - é…ç½®4ç§æ˜¾ç¤ºæ¨¡å¼ï¼ˆç¦ç”¨/ç²—ç•¥/æ··åˆ/è¯¦ç»†ï¼‰
4. **å·¥å…·é“¾æ˜¾ç¤º** - å¼€å…³æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºå·¥å…·é“¾

ç”¨æˆ·å¯ä»¥é€šè¿‡å›¾å½¢ç•Œé¢ç¼–è¾‘æ¯ä¸ªç­–ç•¥çš„è¿™äº›è®¾ç½®ã€‚

## ç•Œé¢å…¥å£

åœ¨**æç¤ºè¯é…ç½®**å¡ç‰‡ä¸­ï¼Œæ–°å¢äº†ä¸€è¡Œï¼š

```
MCPç­–ç•¥ï¼š[å·¥å…·ç­–ç•¥ â–¼] [ç¼–è¾‘ç­–ç•¥]
```

ç‚¹å‡»**"ç¼–è¾‘ç­–ç•¥"**æŒ‰é’®å³å¯æ‰“å¼€ç­–ç•¥æç¤ºè¯ç¼–è¾‘å¯¹è¯æ¡†ã€‚

## ç¼–è¾‘å¯¹è¯æ¡†

### å¸ƒå±€ç»“æ„

```
â”Œâ”€ ç­–ç•¥æç¤ºè¯é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚  â”Œâ”€ å·¦ä¾§ â”€â”€â”€â”  â”Œâ”€ å³ä¾§ï¼ˆå¯æ»šåŠ¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚ ç­–ç•¥åˆ—è¡¨ â”‚  â”‚ å½“å‰ç¼–è¾‘ï¼šæ··åˆåˆ¤æ–­                    â”‚   â”‚
â”‚  â”‚          â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚ â— ç©ºç™½   â”‚  â”‚ ğŸ’¡ å¯ç”¨å˜é‡å ä½ç¬¦                     â”‚   â”‚
â”‚  â”‚   ç­–ç•¥   â”‚  â”‚   $description_rough â†’ ç®€å•åˆ—è¡¨      â”‚   â”‚
â”‚  â”‚          â”‚  â”‚   $description_detailed â†’ è¯¦ç»†åˆ—è¡¨   â”‚   â”‚
â”‚  â”‚ â— æ··åˆ   â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚   åˆ¤æ–­   â”‚  â”‚ ğŸ“Š æ€»å·¥å…·è°ƒç”¨ä¸Šé™ [â•â•â•â•â•â•â•â•â•â•â—â•â•â•â•]   â”‚   â”‚
â”‚  â”‚   (é€‰ä¸­) â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ ğŸ”„ åŒä¸€å·¥å…·è¿ç»­è°ƒç”¨ä¸Šé™ [â•â•â•â•â—â•â•â•â•]   â”‚   â”‚
â”‚  â”‚ â— å·¥å…·   â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚   ä¼˜å…ˆ   â”‚  â”‚ ğŸ“‹ å·¥å…·ç»“æœæ˜¾ç¤ºæ¨¡å¼ [æ··åˆæ˜¾ç¤º â–¼]      â”‚   â”‚
â”‚  â”‚          â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚ â— å·¥å…·   â”‚  â”‚ â›“ï¸ æ˜¾ç¤ºå·¥å…·é“¾ [å¼€å…³]                  â”‚   â”‚
â”‚  â”‚   å¼ºåˆ¶   â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ â”‚                               â”‚   â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ â”‚ You are a helpful assistant   â”‚   â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ â”‚ ...                           â”‚   â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ â”‚                               â”‚   â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚          â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ âš ï¸ æç¤ºè¯ä¸­æœªåŒ…å«å˜é‡å ä½ç¬¦...       â”‚   â”‚
â”‚  â”‚          â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚          â”‚  â”‚ [é‡ç½®ä¸ºé»˜è®¤] [ä¿å­˜] [å–æ¶ˆ]            â”‚   â”‚
â”‚  â”‚          â”‚  â”‚                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠŸèƒ½è¯´æ˜

1. **ç­–ç•¥åˆ—è¡¨**ï¼ˆå·¦ä¾§ï¼‰ï¼šå›ºå®šæ˜¾ç¤º4ä¸ªç­–ç•¥ï¼Œä¸å¯å¢åˆ 
2. **å˜é‡å ä½ç¬¦**ï¼š
   - `$description_rough` - ç®€å•å·¥å…·åˆ—è¡¨ï¼ˆä»…å·¥å…·åç§°ï¼‰
   - `$description_detailed` - è¯¦ç»†å·¥å…·åˆ—è¡¨ï¼ˆåç§°+æè¿°ï¼‰
3. **æ€»å·¥å…·è°ƒç”¨ä¸Šé™**ï¼ˆæ»‘å—ï¼‰ï¼šè®¾ç½®è¯¥ç­–ç•¥çš„æœ€å¤§æ€»å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼ˆ0=æ— é™ï¼‰
4. **åŒä¸€å·¥å…·è¿ç»­è°ƒç”¨ä¸Šé™**ï¼ˆæ»‘å—ï¼‰ï¼šè®¾ç½®åŒä¸€å·¥å…·çš„æœ€å¤§è¿ç»­è°ƒç”¨æ¬¡æ•°ï¼ˆ0=æ— é™ï¼‰
5. **å·¥å…·ç»“æœæ˜¾ç¤ºæ¨¡å¼**ï¼ˆä¸‹æ‹‰æ¡†ï¼‰ï¼šé€‰æ‹©4ç§æ˜¾ç¤ºæ¨¡å¼ä¹‹ä¸€
   - **ç¦ç”¨** - ä¸æ˜¾ç¤ºå·¥å…·ç»“æœå’Œå†…è”æ ‡è®°
   - **ç²—ç•¥** - ä»…å†…è”æ˜¾ç¤ºå·¥å…·å
   - **æ··åˆ** - å†…è”+æˆªæ–­æ˜¾ç¤ºç»“æœ
   - **è¯¦ç»†** - å†…è”+å®Œæ•´æ˜¾ç¤ºç»“æœ
6. **æ˜¾ç¤ºå·¥å…·é“¾**ï¼ˆå¼€å…³ï¼‰ï¼šæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºå·¥å…·é“¾
7. **æ–‡æœ¬ç¼–è¾‘æ¡†**ï¼šç¼–è¾‘ç­–ç•¥çš„ç³»ç»Ÿæç¤ºè¯
8. **éªŒè¯è­¦å‘Š**ï¼šå½“æç¤ºè¯ä¸åŒ…å«å˜é‡æ—¶æ˜¾ç¤ºè­¦å‘Šï¼Œå†æ¬¡ç‚¹å‡»ä¿å­˜å¯å¼ºåˆ¶ä¿å­˜
9. **æŒ‰é’®**ï¼š
   - **é‡ç½®ä¸ºé»˜è®¤**ï¼šæ¢å¤è¯¥ç­–ç•¥çš„æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼
   - **ä¿å­˜**ï¼šä¿å­˜æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®
   - **å–æ¶ˆ**ï¼šæ”¾å¼ƒä¿®æ”¹

## é»˜è®¤æç¤ºè¯

### ç©ºç™½ç­–ç•¥
```
Available MCP tools:
$description_rough
```

### æ··åˆåˆ¤æ–­
```
You are a helpful assistant with access to optional MCP tools.

Available tools:
$description_detailed

Instructions:
- Tools are OPTIONAL - use them only when they can genuinely help answer the question
- For general knowledge, common sense, or simple questions - answer directly WITHOUT tools
- If no tool fits the request, answer directly with your own knowledge
```

### å·¥å…·ä¼˜å…ˆ
```
You are a helpful assistant with access to MCP tools.

Available tools:
$description_detailed

Instructions:
- PRIORITIZE using tools when they can provide better or more accurate information
- If no suitable tool is available, answer directly using your own knowledge
- If a tool fails or returns no useful data, gracefully answer without it
```

### å·¥å…·å¼ºåˆ¶
```
You are a helpful assistant that MUST use available MCP tools.

Available tools:
$description_detailed

CRITICAL INSTRUCTIONS:
- You MUST use tools to answer the question
- If no suitable tool exists, reply: 'No suitable tool available to answer this question.'
- Do not answer from your own knowledge unless explicitly instructed
```

## æŠ€æœ¯å®ç°

### æ•°æ®ç»“æ„

```csharp
// Settings.cs
public Dictionary<McpToolStrategy, string> CustomStrategyPrompts { get; set; } = new();           // è‡ªå®šä¹‰æç¤ºè¯
public Dictionary<McpToolStrategy, int> StrategyConsecutiveToolLimits { get; set; } = new();     // è¿ç»­è°ƒç”¨ä¸Šé™
public Dictionary<McpToolStrategy, int> StrategyTotalToolCallsLimits { get; set; } = new();      // æ€»å·¥å…·è°ƒç”¨ä¸Šé™
public Dictionary<McpToolStrategy, ToolResultDisplayMode> StrategyToolResultDisplayModes { get; set; } = new();  // å·¥å…·ç»“æœæ˜¾ç¤ºæ¨¡å¼
public Dictionary<McpToolStrategy, bool> StrategyToolChainDisplay { get; set; } = new();         // å·¥å…·é“¾æ˜¾ç¤ºå¼€å…³

// Main.cs - é»˜è®¤æç¤ºè¯
public static class DefaultStrategyPrompts
{
    public static string GetDefaultPrompt(McpToolStrategy strategy);
}
```

### æç¤ºè¯ç”Ÿæˆé€»è¾‘

```csharp
private string GetSystemPromptByStrategy(McpToolStrategy strategy, ...)
{
    // 1. è·å–è‡ªå®šä¹‰æç¤ºè¯æˆ–é»˜è®¤æç¤ºè¯
    string prompt = Settings.CustomStrategyPrompts.TryGetValue(...) 
        ?? DefaultStrategyPrompts.GetDefaultPrompt(strategy);
    
    // 2. ç”Ÿæˆä¸¤ç§æ ¼å¼çš„å·¥å…·æè¿°
    var descriptionRough = string.Join("\n", tools.Select(t => $"- {t.Tool.Name}"));
    var descriptionDetailed = string.Join("\n", tools.Select(t => $"- {t.Tool.Name}: {t.Tool.Description}"));
    
    // 3. æ›¿æ¢å˜é‡å ä½ç¬¦
    return prompt
        .Replace("$description_rough", descriptionRough)
        .Replace("$description_detailed", descriptionDetailed);
}
```

### ä¸»é¢˜è¯´æ˜

**å·²å®ç°**ï¼šç¼–è¾‘å¯¹è¯æ¡†å·²æ”¯æŒè·Ÿéš STranslate ä¸»ç¨‹åºçš„ä¸»é¢˜åˆ‡æ¢ï¼ˆæš—è‰²/äº®è‰²ï¼‰ã€‚

**å®ç°æ–¹å¼**ï¼š
- ä½¿ç”¨ Fork ç‰ˆæœ¬çš„ `IPluginContext.ApplyTheme(Window)` æ–¹æ³•
- åœ¨å¯¹è¯æ¡†æ„é€ å‡½æ•°ä¸­ä¼ å…¥ `IPluginContext` å®ä¾‹
- çª—å£åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨ `_context.ApplyTheme(this)` åº”ç”¨ä¸»é¢˜

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
// StrategyPromptDialog.xaml.cs
public StrategyPromptDialog(IPluginContext context)
{
    InitializeComponent();
    _context = context;
    Loaded += OnLoaded;
}

private void OnLoaded(object sender, RoutedEventArgs e)
{
    // åº”ç”¨ä¸»é¢˜ï¼ˆä½¿ç”¨ Fork ç‰ˆæœ¬çš„ ApplyTheme æ¥å£ï¼‰
    _context.ApplyTheme(this);
    // ...
}
```

**æ³¨æ„**ï¼šæ­¤åŠŸèƒ½éœ€è¦ STranslate çš„ Fork ç‰ˆæœ¬æ”¯æŒï¼ˆ`IPluginContext` æ¥å£åŒ…å« `ApplyTheme` æ–¹æ³•ï¼‰ã€‚

## ä½¿ç”¨å»ºè®®

### ä½•æ—¶éœ€è¦è‡ªå®šä¹‰æç¤ºè¯ï¼Ÿ

1. **æ··åˆåˆ¤æ–­ç­–ç•¥å¤ªä¿å®ˆ**ï¼šå¦‚æœè§‰å¾—AIä»ä¸ä½¿ç”¨å·¥å…·ï¼Œå¯ä»¥ä¿®æ”¹æç¤ºè¯è®©AIæ›´ç§¯æ
2. **å·¥å…·ä¼˜å…ˆç­–ç•¥ä¸å¤Ÿæ˜ç¡®**ï¼šå¯ä»¥å¢å¼º"ä¼˜å…ˆ"çš„æè¿°ï¼Œè®©AIæ›´ä¸»åŠ¨ä½¿ç”¨å·¥å…·
3. **ç‰¹å®šåœºæ™¯éœ€æ±‚**ï¼šé’ˆå¯¹ç‰¹å®šç±»å‹çš„æŸ¥è¯¢å®šåˆ¶AIçš„è¡Œä¸º

### è‡ªå®šä¹‰ç¤ºä¾‹

**è®©æ··åˆåˆ¤æ–­ç­–ç•¥æ›´ç§¯æï¼š**
```
You are a helpful assistant with access to MCP tools.

Available tools:
$description_detailed

Instructions:
- You SHOULD use tools whenever they might provide useful information
- Don't hesitate to call tools - it's better to check than to guess
- For factual questions, always use tools to verify before answering
```

**ç®€åŒ–ç©ºç™½ç­–ç•¥ï¼š**
```
You have access to these tools:
$description_detailed

Use them when needed.
```

### æ³¨æ„äº‹é¡¹

1. **å˜é‡å¿…é¡»ä¿ç•™**ï¼šå¦‚æœä¸åŒ…å«`$description_rough`æˆ–`$description_detailed`ï¼Œç³»ç»Ÿä¸ä¼šæ’å…¥å·¥å…·åˆ—è¡¨
2. **è¯­è¨€ä¸€è‡´æ€§**ï¼šæç¤ºè¯è¯­è¨€åº”ä¸AIå¯¹è¯è¯­è¨€ä¸€è‡´ï¼ˆä¸­æ–‡æç¤ºè¯é…ä¸­æ–‡å¯¹è¯ï¼‰
3. **é‡ç½®åŠŸèƒ½**ï¼šéšæ—¶å¯ä»¥é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯
4. **ä¿å­˜å³ç”Ÿæ•ˆ**ï¼šä¿å­˜åä¸‹æ¬¡ç¿»è¯‘ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯

## ç›¸å…³æ–‡ä»¶

- `Settings.cs` - ç­–ç•¥çº§è®¾ç½®æ•°æ®å­—å…¸ï¼ˆCustomStrategyPrompts, StrategyConsecutiveToolLimits, StrategyTotalToolCallsLimits, StrategyToolResultDisplayModes, StrategyToolChainDisplayï¼‰
- `Main.cs` - DefaultStrategyPrompts é»˜è®¤æç¤ºè¯ï¼ŒGetSystemPromptByStrategy æ–¹æ³•ï¼ŒThreeStageContentBuilder å†…å®¹æ„å»ºå™¨
- `View/StrategyPromptDialog.xaml` - ç¼–è¾‘å¯¹è¯æ¡†ç•Œé¢ï¼ˆå¸¦æ»šåŠ¨æ¡ï¼‰
- `ViewModel/StrategyPromptDialogViewModel.cs` - ç¼–è¾‘å¯¹è¯æ¡†è§†å›¾æ¨¡å‹
- `View/SettingsView.xaml` - è®¾ç½®ç•Œé¢ï¼ˆæ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼‰
- `ViewModel/SettingsViewModel.cs` - EditStrategyPromptCommand å‘½ä»¤
